<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Intune Printer Deployment Toolkit</title>
  <!-- Google Font for better typography -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet">
  <style>
    /* Reset & Basic Styling */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: #121212;
      color: #e0e0e0;
    }
    header {
      background: #bb86fc;
      color: white;
      padding: 0.5rem;
      margin-top: 1.5rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
      position: relative;
      left: 25%;
      max-width: 50%;
      border-radius: 8px;
    }
    h1 {
      margin: 0;
      font-weight: 500;
    }
    .container {
      max-width: 50%;
      margin: 2rem auto;
      background: #1e1e1e;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.7);
    }
    
    /* Tabs Styling */
    .tab {
      display: flex;
      border-bottom: 2px solid #444;
      margin-bottom: 1.5rem;
    }
    .tab button {
      flex: 1;
      background: #2e2e2e;
      border: none;
      outline: none;
      padding: 1rem;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s, color 0.3s;
      color: #e0e0e0;
      border-radius: 2px;
    }
    .tab button:hover {
      background: #3e3e3e;
    }
    .tab button.active {
      background: #bb86fc;
      color: white;
      font-weight: 500;
    }
    .tabcontent {
      display: none;
    }
    
    /* Section Styling */
    .section {
      margin-bottom: 1.5rem;
      padding: 1rem;
      border: 1px solid #444;
      border-radius: 6px;
      background: #2e2e2e;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .section h2 {
      margin-top: 0;
      color: #bb86fc;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      font-weight: 400;
    }
    input[type="text"], select, input[type="file"] {
      width: 97.5%;
      padding: 0.6rem;
      margin-top: 0.3rem;
      border: 1px solid #555;
      border-radius: 4px;
      font-size: 14px;
      background: #333;
      color: #e0e0e0;
    }
    
    /* About Section Styling */
    #About {
      padding: 1rem;
      background: linear-gradient(135deg, #2e2e2e, #1e1e1e);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    #About h2 {
      color: #bb86fc;
      text-align: center;
      font-size: 24px;
      margin-bottom: 1rem;
    }
    #About p {
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 0.8rem;
    }
    #About a {
      color: #bb86fc;
      text-decoration: none;
    }
    #About a:hover {
      text-decoration: underline;
    }
    
    /* Driver Details Horizontal Layout */
    .driver-details-container {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .driver-details-column {
      flex: 1;
      min-width: 200px;
    }
    .driver-details-column h3 {
      margin: 0.5rem 0 0.3rem;
      font-size: 16px;
      color: #bb86fc;
    }
    
    /* Navigation Button Styling */
    button.nav {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      background: #bb86fc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }
    button.nav:hover {
      background: #9b6bfc;
    }
    
    /* Intune Download Button Styling */
    button.nav.intune-download-btn {
      background: #0078D4 !important;
    }
    button.nav.intune-download-btn:hover {
      background: #006cbd !important;
    }
    
    /* Command Preview Container */
    .preview-container {
      display: flex;
      align-items: center;
      background: #333;
      padding: 0.5rem;
      border: 1px solid #555;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    .preview-text {
      flex-grow: 1;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 14px;
      color: #e0e0e0;
    }
    .copy-btn {
      margin-left: 0.5rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.2rem;
    }
    .copy-btn svg {
      vertical-align: middle;
      fill: #BB86FC;
    }
    
    /* Detection Registry Instructions */
    .detection-block {
      margin-bottom: 1rem;
    }
    .detection-label {
      font-weight: bold;
      margin-bottom: 0.2rem;
    }
    .detection-value {
      margin-left: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .detection-purple {
      color: #bb86fc;
    }
    
    /* Navigation Group for Section 3 */
    .nav-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    /* Spinner Styling */
    .spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #bb86fc;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.75s linear infinite;
      vertical-align: middle;
      margin-right: 0.5rem;
    }
    .azure-spinner {
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Footer Styling */
    footer {
      text-align: center;
      margin-top: 2rem;
      padding: 1rem;
      font-size: 12px;
      color: #aaa;
    }
    
    /* Responsive styling for mobile devices */
    @media (max-width: 600px) {
      .container {
        max-width: 90%;
        padding: 1rem;
      }
      header {
        left: 5%;
        max-width: 90%;
      }
      .driver-details-container {
        flex-direction: column;
      }
      .nav-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Printune</h1>
  </header>
  <div class="container">
    <!-- Tab Navigation -->
    <div class="tab">
      <button class="tablinks active" onclick="openTab(event, 'Config')">Config</button>
      <button class="tablinks" onclick="openTab(event, 'About')">About</button>
    </div>
    
    <!-- Config Tab -->
    <div id="Config" class="tabcontent" style="display: block;">
      <div id="installFormContainer">
        <!-- Section 1: Printer Details -->
        <div class="section" id="section1">
          <h2>Printer Details</h2>
          <label for="ipAddress">Printer Port IP Address:</label>
          <input type="text" id="ipAddress" placeholder="10.195.100.200" oninput="updateAllPreviews()">
          
          <label for="portName">Printer Port Name:</label>
          <input type="text" id="portName" placeholder="Intune Deployed - Company - 10.195.100.200" oninput="updateAllPreviews()">
          
          <label for="printerName">Printer Name:</label>
          <input type="text" id="printerName" placeholder="Upstairs Printer" oninput="updateAllPreviews()">

          <!-- Brand & Model Dropdowns -->
          <label for="brandSelect">Printer Brand:</label>
          <select id="brandSelect" onchange="onBrandChange()">
            <option value="">--Select Brand--</option>
          </select>
          
          <label for="modelSelect">Printer Model:</label>
          <select id="modelSelect" onchange="onModelChange()">
            <option value="">--Select Model--</option>
          </select>
          
          <button class="nav" type="button" onclick="nextSection('section1', 'section2')">Next</button>
        </div>
        
        <!-- Section 2: Driver Details -->
        <div class="section" id="section2" style="display: none;">
          <h2>Driver Details</h2>
          <!-- First Row: Driver File -->
          <div class="driver-details-container">
            <div class="driver-details-column">
              <h3>Driver File (Manual)</h3>
              <input type="text" id="driverModelFile" placeholder="BROHL17A.INF" oninput="updateAllPreviews()">
            </div>
            <div class="driver-details-column">
              <h3>Upload .inf</h3>
              <input type="file" id="infFile" accept=".inf">
              <p style="font-size: 12px; color: #aaa; margin: 0.3rem 0 0;">Auto-detect models</p>
            </div>
          </div>
          <!-- Second Row: Driver Model Name -->
          <div class="driver-details-container" style="margin-top: 1rem;">
            <div class="driver-details-column">
              <h3>Driver Model Name (Manual)</h3>
              <input type="text" id="driverModelNameText" placeholder="Brother HL-L2350DW series" oninput="updateAllPreviews()">
            </div>
            <div class="driver-details-column">
              <h3>Select Model from INF</h3>
              <select id="driverModelNameSelect" onchange="updateAllPreviews()">
                <option value="">--Select Model--</option>
              </select>
            </div>
          </div>
          <div style="margin-top:1rem;">
            <button class="nav" type="button" onclick="previousSection('section2', 'section1')">Previous</button>
            <button class="nav" type="button" onclick="nextSection('section2', 'section3')">Next</button>
          </div>
        </div>
        
        <!-- Section 3: Driver & Config Settings -->
        <div class="section" id="section3" style="display: none;">
          <h2>Driver & Config Settings</h2>
          <label for="driverZipFile">Printer Driver ZIP File Name (Required):</label>
          <input type="text" id="driverZipFile" list="driverZipOptions" placeholder="Select driver ZIP" oninput="updateAllPreviews()">
          <datalist id="driverZipOptions"></datalist>
          
          <label for="configFilePath">Config File Path (Optional):</label>
          <input type="text" id="configFilePath" placeholder="config.dat" oninput="updateAllPreviews()">
          
          <!-- Navigation Group -->
          <div class="nav-group">
            <button class="nav" type="button" onclick="downloadPackage()">Download Package</button>
            <button class="nav intune-download-btn" type="button" onclick="downloadIntuneWin()">
              <span class="btn-content">Download IntuneWin</span>
            </button>
            <button class="nav" type="button" onclick="previousSection('section3', 'section2')">Previous</button>
          </div>
          
          <h2>Install Command</h2>
          <div class="preview-container">
            <div id="installCommandPreview" class="preview-text"></div>
            <button class="copy-btn" onclick="copyText('installCommandPreview', this)">
              <svg width="16" height="16" viewBox="0 0 24 24">
                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14a2 2 0 0 0 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
              </svg>
            </button>
          </div>
          
          <h2>Uninstall Command</h2>
          <div class="preview-container">
            <div id="uninstallCommandPreview" class="preview-text"></div>
            <button class="copy-btn" onclick="copyText('uninstallCommandPreview', this)">
              <svg width="16" height="16" viewBox="0 0 24 24">
                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14a2 2 0 0 0 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
              </svg>
            </button>
          </div>
          
          <h2>Detection Registry Instructions</h2>
          <div id="detectionPreview"></div>
        </div>
      </div>
    </div>
    
    <!-- About Tab -->
    <div id="About" class="tabcontent">
      <h2>About Printune</h2>
      <p style="text-align: center">Printune was born out of countless frustrating experiences discovering inconsistent printer deployments via Intune.</p>
      <p style="text-align: center">Tired of imprecise configurations and the challenges of manual setups, I created a toolkit that makes deploying printers faster and more consistent for all levels of skill.</p>
      <p style="text-align: center">This streamlined interface and smart automation simplifies every step – from specifying printer details to organising deployment scripts.</p>
      <p style="text-align: center"><a href="https://github.com/NickJongens/Printune" target="_blank">GitHub repository</a></p>
    </div>
  </div>
  
  <!-- Footer -->
  <footer>
    &copy; Nick Jongens - 2025
  </footer>
  
  <!-- Include JSZip Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <script>
    // Global icon variables for copy/tick buttons
    const copyIconHTML = `<svg width="16" height="16" viewBox="0 0 24 24">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14a2 2 0 0 0 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>`;
    const tickIconHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>`;
    
    function animateCopyButton(btn, originalIconHTML) {
      btn.innerHTML = tickIconHTML;
      setTimeout(() => {
        btn.innerHTML = originalIconHTML;
      }, 1000);
    }
    
    /* ---------------------------
       Dynamic Driver List
       --------------------------- */
    function populateDriverDatalist() {
      fetch('/drivers.json')
        .then(response => response.json())
        .then(data => {
          const datalist = document.getElementById("driverZipOptions");
          datalist.innerHTML = "";
          data.forEach(driver => {
            const option = document.createElement("option");
            option.value = driver;
            datalist.appendChild(option);
          });
        })
        .catch(error => {
          console.error("Error fetching driver list:", error);
        });
    }
    
    /* ---------------------------
       Models Dropdown Population
       --------------------------- */
    let modelsData = {};

    function populateBrandDropdown() {
      fetch('/models.json')
        .then(response => response.json())
        .then(data => {
          modelsData = data;
          const brandSelect = document.getElementById("brandSelect");
          brandSelect.innerHTML = '<option value="">--Select Brand--</option>';
          for (let brand in data) {
            const option = document.createElement("option");
            option.value = brand;
            option.textContent = brand;
            brandSelect.appendChild(option);
          }
        })
        .catch(error => {
          console.error("Error fetching models.json:", error);
        });
    }

    function onBrandChange() {
      const brand = document.getElementById("brandSelect").value;
      const modelSelect = document.getElementById("modelSelect");
      modelSelect.innerHTML = '<option value="">--Select Model--</option>';
      
      if (brand === "Manual" || !brand) {
        const manualOption = document.createElement("option");
        manualOption.value = "Manual";
        manualOption.textContent = "Manual";
        modelSelect.appendChild(manualOption);
        return;
      }
      if (modelsData[brand] && modelsData[brand].models) {
        modelsData[brand].models.forEach(model => {
          const option = document.createElement("option");
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
      }
    }

    function onModelChange() {
      const brand = document.getElementById("brandSelect").value;
      const model = document.getElementById("modelSelect").value;
      if (!brand || brand === "Manual" || !model) return;
      const mapping = modelsData[brand];
      if(mapping) {
         document.getElementById("driverZipFile").value = mapping.driverZip || "";
         document.getElementById("driverModelFile").value = mapping.driverInf || "";
         document.getElementById("driverModelNameText").value = model;
         updateAllPreviews();
      }
    }
    
    /* ---------------------------
       Tab & Section Navigation
       --------------------------- */
    function openTab(evt, tabName) {
      const tabcontent = document.getElementsByClassName("tabcontent");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }
    function nextSection(currentId, nextId) {
      document.getElementById(currentId).style.display = "none";
      document.getElementById(nextId).style.display = "block";
    }
    function previousSection(currentId, prevId) {
      document.getElementById(currentId).style.display = "none";
      document.getElementById(prevId).style.display = "block";
    }
    
    /* ---------------------------
       INF File Handling
       --------------------------- */
    function parseInfModels(infContent) {
      const lines = infContent.split(/\r?\n/);
      const models = new Set();
      let currentSection = "";
      for (const line of lines) {
        if (line.trim().startsWith(';')) continue;
        const sectionMatch = line.match(/^\s*\[([^\]]+)\]/);
        if (sectionMatch) {
          currentSection = sectionMatch[1].trim().toUpperCase();
          continue;
        }
        if (currentSection.startsWith("PRINTERS") || currentSection === "DRIVERNAME") {
          const modelMatch = line.match(/^\s*"([^"]+)"\s*=/);
          if (modelMatch) models.add(modelMatch[1].trim());
        } else if (currentSection === "STRINGS") {
          const printerKeyMatch = line.match(/^\s*PRINTER\d+\s*=\s*"([^"]+)"\s*$/i);
          if (printerKeyMatch) models.add(printerKeyMatch[1].trim());
        } else if (currentSection.startsWith("BRDRV_WINUSB")) { 
          const usbModelMatch = line.match(/^\s*"([^"]+)"\s*=/);
          if (usbModelMatch) models.add(usbModelMatch[1].trim());
        } else if (currentSection.startsWith("FFIDPF")) {
          const ffidpfModelMatch = line.match(/^\s*"([^"]+)"\s*=/);
          if (ffidpfModelMatch) models.add(ffidpfModelMatch[1].trim());
        }
      }
      return Array.from(models);
    }
    document.getElementById("infFile").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      document.infUploadedFileName = file.name;
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const models = parseInfModels(content);
        const selectEl = document.getElementById("driverModelNameSelect");
        selectEl.innerHTML = '<option value="">--Select Model--</option>';
        if (models.length > 0) {
          models.forEach(model => {
            const option = document.createElement("option");
            option.value = model;
            option.textContent = model;
            selectEl.appendChild(option);
          });
        } else {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No models found in INF";
          selectEl.appendChild(option);
        }
        updateAllPreviews();
      };
      reader.readAsText(file);
    });
    
    /* ---------------------------
       Command Generation
       --------------------------- */
    function updateInstallPreview() {
      const ipAddress = (document.getElementById("ipAddress")?.value || "").trim();
      const portName = (document.getElementById("portName")?.value || "").trim();
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      let driverModelFile = document.infUploadedFileName ? document.infUploadedFileName : (document.getElementById("driverModelFile")?.value || "").trim();
      let driverModelName = (document.getElementById("driverModelNameSelect")?.value || "").trim() || (document.getElementById("driverModelNameText")?.value || "").trim();
      const driverZipFile = (document.getElementById("driverZipFile")?.value || "").trim();
      const configFilePath = (document.getElementById("configFilePath")?.value || "").trim();
      
      let command = `powershell.exe -ExecutionPolicy Bypass -File Install.ps1 `;
      if (ipAddress) command += `-PrinterPortIPAddress "<strong style='color:#bb86fc;'>${ipAddress}</strong>" `;
      if (portName) command += `-PrinterPortName "<strong style='color:#bb86fc;'>${portName}</strong>" `;
      if (printerName) command += `-PrinterName "<strong style='color:#bb86fc;'>${printerName}</strong>" `;
      if (driverModelName) command += `-PrinterDriverModelName "<strong style='color:#bb86fc;'>${driverModelName}</strong>" `;
      if (driverZipFile) command += `-PrinterDriverZipFileName "<strong style='color:#bb86fc;'>${driverZipFile}</strong>" `;
      if (driverModelFile) command += `-PrinterDriverModelFileName "<strong style='color:#bb86fc;'>${driverModelFile}</strong>" `;
      if (configFilePath) command += `-ConfigFilePath "<strong style='color:#bb86fc;'>${configFilePath}</strong>" `;
      
      document.getElementById("installCommandPreview").innerHTML = command;
    }
    function updateUninstallPreview() {
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      const portName = (document.getElementById("portName")?.value || "").trim();
      let command = 'powershell.exe -ExecutionPolicy Bypass -File Uninstall.ps1 ';
      if (printerName) command += `-PrinterName "<strong style='color:#bb86fc;'>${printerName}</strong>" `;
      if (portName) command += `-PrinterPortName "<strong style='color:#bb86fc;'>${portName}</strong>" `;
      document.getElementById("uninstallCommandPreview").innerHTML = command;
    }
    function getPlainInstallCommand() {
      const ipAddress = (document.getElementById("ipAddress")?.value || "").trim();
      const portName = (document.getElementById("portName")?.value || "").trim();
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      let driverModelFile = document.infUploadedFileName ? document.infUploadedFileName : (document.getElementById("driverModelFile")?.value || "").trim();
      let driverModelName = (document.getElementById("driverModelNameSelect")?.value || "").trim() || (document.getElementById("driverModelNameText")?.value || "").trim();
      const driverZipFile = (document.getElementById("driverZipFile")?.value || "").trim();
      const configFilePath = (document.getElementById("configFilePath")?.value || "").trim();
      
      let command = `powershell.exe -ExecutionPolicy Bypass -File Install.ps1 `;
      if (ipAddress) command += `-PrinterPortIPAddress "${ipAddress}" `;
      if (portName) command += `-PrinterPortName "${portName}" `;
      if (printerName) command += `-PrinterName "${printerName}" `;
      if (driverModelName) command += `-PrinterDriverModelName "${driverModelName}" `;
      if (driverZipFile) command += `-PrinterDriverZipFileName "${driverZipFile}" `;
      if (driverModelFile) command += `-PrinterDriverModelFileName "${driverModelFile}" `;
      if (configFilePath) command += `-ConfigFilePath "${configFilePath}" `;
      return command.trim();
    }
    function getPlainUninstallCommand() {
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      const portName = (document.getElementById("portName")?.value || "").trim();
      let command = 'powershell.exe -ExecutionPolicy Bypass -File Uninstall.ps1 ';
      if (printerName) command += `-PrinterName "${printerName}" `;
      if (portName) command += `-PrinterPortName "${portName}" `;
      return command.trim();
    }
    function updateAllPreviews() {
      updateInstallPreview();
      updateUninstallPreview();
      updateDetectionPreview();
    }
    function updateDetectionPreview() {
      const printerName = (document.getElementById("printerName")?.value || "<PrinterName>").trim();
      const container = document.getElementById("detectionPreview");
      container.innerHTML = "";
      
      const detectionFields = [
        { label: "Registry Key Path:", value: `HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Print\\Printers\\${printerName}`, copy: true, purple: true },
        { label: "Value name:", value: "Name", copy: true, purple: true },
        { label: "Detection method:", value: "String comparison", copy: true, purple: true },
        { label: "Operator:", value: "Equals", copy: false, purple: true },
        { label: "Value:", value: printerName, copy: true, purple: true }
      ];
      
      detectionFields.forEach(field => {
        const block = document.createElement("div");
        block.className = "detection-block";
        
        const labelDiv = document.createElement("div");
        labelDiv.className = "detection-label";
        labelDiv.innerText = field.label;
        block.appendChild(labelDiv);
        
        const valueDiv = document.createElement("div");
        valueDiv.className = "detection-value";
        if (field.purple) { valueDiv.classList.add("detection-purple"); }
        valueDiv.innerText = field.value;
        
        if (field.copy) {
          const btn = document.createElement("button");
          btn.className = "copy-btn";
          btn.innerHTML = copyIconHTML;
          btn.onclick = function() {
            navigator.clipboard.writeText(field.value)
              .then(() => { animateCopyButton(btn, copyIconHTML); })
              .catch(err => { console.error("Error copying text:", err); });
          };
          valueDiv.appendChild(btn);
        }
        block.appendChild(valueDiv);
        container.appendChild(block);
      });
    }
    
    // Copy function for command previews
    function copyText(elementId, btn) {
      const el = document.getElementById(elementId);
      const text = el.innerText || el.textContent;
      navigator.clipboard.writeText(text)
        .then(() => { animateCopyButton(btn, copyIconHTML); })
        .catch(err => { console.error("Error copying text:", err); });
    }
    
    /* ---------------------------
       Package Download Functions
       --------------------------- */
    async function generateZipPackage() {
      const zip = new JSZip();
      const promises = [];

      // Add Install.ps1
      const installPromise = fetch("/Install.ps1")
        .then(response => response.text())
        .then(text => zip.file("Install.ps1", text));
      promises.push(installPromise);

      // Add Uninstall.ps1
      const uninstallPromise = fetch("/Uninstall.ps1")
        .then(response => response.text())
        .then(text => zip.file("Uninstall.ps1", text));
      promises.push(uninstallPromise);

      // Add driver ZIP if specified
      const driverZipFileName = (document.getElementById("driverZipFile")?.value || "").trim();
      if (driverZipFileName) {
        const driverPromise = fetch(`/${driverZipFileName}`)
          .then(response => response.arrayBuffer())
          .then(data => zip.file(driverZipFileName, data));
        promises.push(driverPromise);
      }

      await Promise.all(promises);
      return zip.generateAsync({ type: "blob" });
    }

    function sanitizeFileName(name) {
      return name.replace(/[<>:"/\\|?*]+/g, "_") || "PrinterDeployment";
    }

    function triggerDownload(blob, mimeType, fileName) {
      const url = window.URL.createObjectURL(new Blob([blob], { type: mimeType }));
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    }

    async function downloadPackage() {
      const btn = document.querySelector('#section3 button[onclick="downloadPackage()"]');
      const originalContent = btn.innerHTML;
      btn.innerHTML = '<div class="spinner"></div> Processing...';
      btn.disabled = true;

      try {
        const zipContent = await generateZipPackage();
        const printerName = sanitizeFileName(document.getElementById("printerName").value.trim());
        triggerDownload(zipContent, "application/zip", `${printerName}.zip`);
      } catch (error) {
        console.error("Package generation error:", error);
        alert(`Error generating package: ${error.message}`);
      } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
      }
    }

    async function downloadIntuneWin() {
      const btn = document.querySelector('.intune-download-btn');
      const originalContent = btn.innerHTML;
      btn.innerHTML = '<div class="spinner azure-spinner"></div> Processing...';
      btn.disabled = true;

      try {
        const zipContent = await generateZipPackage();
        const printerName = sanitizeFileName(document.getElementById("printerName").value.trim());
        
        const formData = new FormData();
        formData.append("zipFile", zipContent, `${printerName}.zip`);
        formData.append("setupFileName", "Install.ps1");

        const response = await fetch("https://packtune.jongens.nz/api/Package", {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }

        const intuneBlob = await response.blob();
        triggerDownload(intuneBlob, "application/intunewin", `${printerName}.intunewin`);
      } catch (error) {
        console.error("Intune packaging error:", error);
        alert(`IntuneWin creation failed: ${error.message}`);
      } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
      }
    }
    
    // Initialize the dynamic lists on DOMContentLoaded
    document.addEventListener("DOMContentLoaded", function() {
      populateDriverDatalist();
      populateBrandDropdown();
    });
  </script>
</body>
</html>
