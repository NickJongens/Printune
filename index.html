<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Intune Printer Deployment Toolkit</title>
  <!-- Google Font for better typography -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" rel="stylesheet">
  <style>
    /* CSS Variables for Theme Support */
    :root {
      --bg-primary: #fefefe;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8fafc;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --accent-color: #3b82f6;
      --accent-hover: #2563eb;
      --border-color: #e2e8f0;
      --shadow-color: rgba(15,23,42,0.04);
      --accent-shadow: rgba(59,130,246,0.15);
      --highlight-color: #3b82f6;
    }

    [data-theme="dark"] {
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-tertiary: #2e2e2e;
      --text-primary: #e0e0e0;
      --text-secondary: #aaa;
      --accent-color: #bb86fc;
      --accent-hover: #a36ef6;
      --border-color: #444;
      --shadow-color: rgba(0,0,0,0.7);
      --accent-shadow: rgba(155,107,252,0.12);
      --highlight-color: #bb86fc;
    }

    /* Reset & Basic Styling */
body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* Header - Minimal Floating Title (updated) */
header {
  background: none;            /* remove bulky purple box */
  color: inherit;
  padding: 0;
  margin-top: 2rem;
  text-align: center;
  position: relative;
  left: 0;
  max-width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 2rem;
}

/* Theme Toggle Button */
.theme-toggle {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  color: var(--text-primary);
}

.theme-toggle:hover {
  background: var(--accent-color);
  color: white;
  transform: scale(1.1);
}

.theme-toggle svg {
  width: 20px;
  height: 20px;
}

/* Gradient clipped title with soft glow */
h1 {
  margin: 0;
  font-weight: 600;
  font-size: 2.2rem;
  display: inline-block;
  line-height: 1;
  background: linear-gradient(90deg, var(--accent-color), var(--accent-hover));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 6px 24px var(--accent-shadow); /* subtle halo */
  padding: 0.1rem 0; /* tiny vertical breathing room */
}

/* Container (kept from base, slightly tightened for visual balance) */
.container {
  max-width: 70%;
  margin: 2rem auto;
  background: var(--bg-secondary);
  padding: 2rem;
  border-radius: 8px;
  box-shadow: 0 4px 8px var(--shadow-color);
  transition: background-color 0.3s ease;
}

/* Tabs Styling */
.tab {
  display: flex;
  border-bottom: 2px solid var(--border-color);
  margin-bottom: 1.5rem;
}
.tab button {
  flex: 1;
  background: var(--bg-tertiary);
  border: none;
  outline: none;
  padding: 1rem;
  font-size: 16px;
  cursor: pointer;
  transition: background 0.22s cubic-bezier(.2,.9,.2,1), color 0.22s;
  color: var(--text-primary);
  border-radius: 4px 4px 0 0;
  margin-right: 0.5rem;
}
.tab button:last-child { margin-right: 0; }
.tab button:hover {
  background: var(--bg-tertiary);
  opacity: 0.8;
}
.tab button.active {
  background: var(--accent-color);
  color: white;
  font-weight: 500;
  box-shadow: 0 6px 18px var(--accent-shadow);
}
.tabcontent {
  display: none;
}

/* Section Styling */
.section {
  margin-bottom: 1.5rem;
  padding: 1rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  background: var(--bg-tertiary);
  box-shadow: 0 2px 4px var(--shadow-color);
  transition: all 0.3s ease;
  animation: slideIn 0.4s ease-out;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.section h2 {
  margin-top: 0;
  color: var(--accent-color);
}
label {
  display: block;
  margin-top: 0.75rem;
  font-weight: 400;
  color: var(--text-primary);
}
input[type="text"], select, input[type="file"] {
  width: 97.5%;
  padding: 0.6rem;
  margin-top: 0.3rem;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  font-size: 14px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  transition: all 0.3s ease;
}

input[type="text"]:focus, select:focus, input[type="file"]:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px var(--accent-shadow);
  transform: translateY(-1px);
}

input[type="text"]:invalid {
  border-color: #ef4444;
}

/* About Section Styling */
#About {
  padding: 1rem;
  background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
  border-radius: 8px;
  box-shadow: 0 2px 4px var(--shadow-color);
}
#About h2 {
  color: var(--accent-color);
  text-align: center;
  font-size: 24px;
  margin-bottom: 1rem;
}
#About p {
  font-size: 16px;
  line-height: 1.5;
  margin-bottom: 0.8rem;
  color: var(--text-primary);
}
#About a {
  color: var(--accent-color);
  text-decoration: none;
}
#About a:hover {
  text-decoration: underline;
}

/* Driver Details Horizontal Layout */
.driver-details-container {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}
.driver-details-column {
  flex: 1;
  min-width: 200px;
}
.driver-details-column h3 {
  margin: 0.5rem 0 0.3rem;
  font-size: 16px;
  color: var(--accent-color);
}

/* Navigation Button Styling (kept but modernised slightly) */
button.nav {
  margin-top: 1rem;
  padding: 0.75rem 1.5rem;
  background: linear-gradient(180deg, var(--accent-color), var(--accent-hover));
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px var(--accent-shadow);
  position: relative;
  overflow: hidden;
}

button.nav:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px var(--accent-shadow);
}

button.nav:active {
  transform: translateY(0);
  box-shadow: 0 2px 8px var(--accent-shadow);
}

button.nav:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

button.nav:disabled:hover {
  transform: none;
  box-shadow: 0 4px 12px var(--accent-shadow);
}

/* Loading state for buttons */
button.nav.loading {
  pointer-events: none;
}

button.nav.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid transparent;
  border-top: 2px solid white;
  border-radius: 50%;
  animation: buttonSpin 1s linear infinite;
}

@keyframes buttonSpin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Intune Download Button Styling (left intact but with softer corners) */
button.nav.intune-download-btn {
  background: #0078D4 !important;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0,120,212,0.08);
}
button.nav.intune-download-btn:hover {
  background: #006cbd !important;
  transform: translateY(-2px);
}

/* Command Preview Container */
.preview-container {
  display: flex;
  align-items: flex-start;
  background: var(--bg-secondary);
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-bottom: 1rem;
  transition: background-color 0.3s ease, border-color 0.3s ease;
  box-shadow: 0 1px 3px var(--shadow-color);
  max-width: 100%;
  overflow: hidden;
}
.preview-text {
  flex-grow: 1;
  white-space: pre-wrap;
  word-wrap: break-word;
  overflow-wrap: break-word;
  font-size: 13px;
  color: var(--text-primary);
  padding: 0.25rem 0;
  line-height: 1.5;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  max-width: calc(100% - 3rem);
}
.copy-btn {
  margin-left: 0.5rem;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: 4px;
  cursor: pointer;
  padding: 0.4rem;
  transition: all 0.2s ease;
  flex-shrink: 0;
}
.copy-btn:hover {
  background: var(--accent-color);
  border-color: var(--accent-color);
}
.copy-btn:hover svg {
  fill: white;
}
.copy-btn svg {
  vertical-align: middle;
  fill: var(--accent-color);
  transition: fill 0.2s ease;
}

/* Detection Registry Instructions */
.detection-block {
  margin-bottom: 1rem;
}
.detection-label {
  font-weight: bold;
  margin-bottom: 0.2rem;
  color: var(--text-primary);
}
.detection-value {
  margin-left: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  word-break: break-all;
  overflow-wrap: break-word;
}
.detection-purple {
  color: var(--accent-color);
}

/* Navigation Group for Section 3 */
.nav-group {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.bottom-nav {
  margin-top: 2rem;
  margin-bottom: 0;
  justify-content: space-between;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border-color);
}

/* Vertical Stack Layout for Section 3 */
.section3-layout {
  display: flex;
  flex-direction: column;
  gap: 2rem;
  margin-top: 1rem;
  max-width: 100%;
  overflow: hidden;
}

.section3-column {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

.section3-column h2 {
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 20px;
  font-weight: 600;
  color: var(--accent-color);
  border-bottom: 2px solid var(--border-color);
  padding-bottom: 0.5rem;
}

.section3-column .preview-container {
  margin-bottom: 1rem;
}

/* Config Export Column specific styling */
.config-export-column {
  background: var(--bg-tertiary);
  padding: 1.25rem;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  max-width: 100%;
  overflow: hidden;
}

.config-export-column input {
  width: 100%;
  margin-bottom: 1rem;
  font-size: 14px;
  max-width: 350px;
}

.config-export-column label {
  font-weight: 500;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
}

/* Commands Column specific styling */
.commands-column {
  background: var(--bg-tertiary);
  padding: 1.25rem;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  max-width: 100%;
  overflow: hidden;
}

.commands-column .preview-container {
  margin-bottom: 1.5rem;
  max-width: 100%;
  overflow: hidden;
}

.command-section {
  margin-bottom: 2rem;
}

.command-section:last-child {
  margin-bottom: 0;
}

/* Detection section specific styling */
.detection-column {
  background: var(--bg-tertiary);
  padding: 1.25rem;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  max-width: 100%;
  overflow: hidden;
}

.detection-block {
  margin-bottom: 1rem;
  padding: 0.75rem;
  background: var(--bg-secondary);
  border-radius: 6px;
  border: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.detection-label {
  font-weight: 600;
  margin-bottom: 0;
  font-size: 14px;
  color: var(--text-primary);
  flex-shrink: 0;
  margin-right: 1rem;
}

.detection-value {
  word-break: break-all;
  font-size: 13px;
  line-height: 1.4;
  flex-grow: 1;
  text-align: right;
}

/* Responsive adjustments for vertical layout */
@media (max-width: 1200px) {
  .container {
    max-width: 80%;
  }
}

@media (max-width: 768px) {
  .container {
    max-width: 95%;
    padding: 1rem;
  }
  
  .section3-layout {
    gap: 1.5rem;
  }
  
  .config-export-column,
  .commands-column,
  .detection-column {
    padding: 1rem;
  }
  
  .detection-block {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .detection-value {
    text-align: left;
  }
  
  .preview-text {
    font-size: 11px;
  }
}

/* Spinner Styling */
.spinner {
  display: inline-block;
  width: 1rem;
  height: 1rem;
  border: 2px solid var(--accent-color);
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 0.75s linear infinite;
  vertical-align: middle;
  margin-right: 0.5rem;
}
.azure-spinner {
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Footer Styling */
footer {
  text-align: center;
  margin-top: 2rem;
  padding: 1rem;
  font-size: 12px;
  color: var(--text-secondary);
}

/* Responsive styling for mobile devices */
@media (max-width: 600px) {
  .container {
    max-width: 95%;
    padding: 1rem;
    margin: 1rem auto;
  }
  header {
    margin-top: 1rem;
    padding: 0 1rem;
  }
  h1 {
    font-size: 1.6rem;
  }
  .driver-details-container {
    flex-direction: column;
  }
  .nav-group {
    flex-direction: column;
    gap: 0.75rem;
  }
  .bottom-nav {
    flex-direction: column-reverse;
    gap: 0.75rem;
  }
  .tab button {
    padding: 0.8rem;
    font-size: 15px;
    min-height: 44px; /* Touch target size */
  }
  .section3-layout {
    gap: 1rem;
  }
  .theme-toggle {
    width: 44px;
    height: 44px;
    min-height: 44px; /* Touch target size */
  }
  .theme-toggle svg {
    width: 20px;
    height: 20px;
  }
  button.nav {
    min-height: 44px;
    padding: 0.75rem 1rem;
    font-size: 16px;
  }
  input[type="text"], select, input[type="file"] {
    min-height: 44px;
    font-size: 16px; /* Prevents zoom on iOS */
  }
  .copy-btn {
    min-width: 44px;
    min-height: 44px;
    padding: 0.5rem;
  }
}

  </style>
</head>
<body>
  <header>
    <div></div>
    <h1>Printune</h1>
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>
      </svg>
    </button>
  </header>
  <div class="container">
    <!-- Tab Navigation -->
    <div class="tab">
      <button class="tablinks active" onclick="openTab(event, 'Config')">Config</button>
      <button class="tablinks" onclick="openTab(event, 'About')">About</button>
    </div>
    
    <!-- Config Tab -->
    <div id="Config" class="tabcontent" style="display: block;">
      <div id="installFormContainer">
        <!-- Section 1: Printer Details -->
        <div class="section" id="section1">
          <h2>Printer Details</h2>
          <label for="ipAddress">Printer Port IP Address:</label>
          <input type="text" id="ipAddress" placeholder="10.195.100.200" oninput="updateAllPreviews()">
          
          <label for="portName">Printer Port Name:</label>
          <input type="text" id="portName" placeholder="Intune Deployed - Company - 10.195.100.200" oninput="updateAllPreviews()">
          
          <label for="printerName">Printer Name:</label>
          <input type="text" id="printerName" placeholder="Upstairs Printer" oninput="updateAllPreviews()">

          <!-- Brand & Model Dropdowns -->
          <label for="brandSelect">Printer Brand:</label>
          <select id="brandSelect" onchange="onBrandChange()">
            <option value="">--Select Brand--</option>
          </select>
          
          <label for="modelSelect">Printer Model:</label>
          <select id="modelSelect" onchange="onModelChange()">
            <option value="">--Select Model--</option>
          </select>
          
          <button class="nav" type="button" onclick="nextSection('section1', 'section2')">Next</button>
        </div>
        
        <!-- Section 2: Driver Details -->
        <div class="section" id="section2" style="display: none;">
          <h2>Driver Details</h2>
          <!-- First Row: Driver File -->
          <div class="driver-details-container">
            <div class="driver-details-column">
              <h3>Driver File (Manual)</h3>
              <input type="text" id="driverModelFile" placeholder="BROHL17A.INF" oninput="updateAllPreviews()">
            </div>
            <div class="driver-details-column">
              <h3>Upload .inf</h3>
              <input type="file" id="infFile" accept=".inf">
              <p style="font-size: 12px; color: var(--text-secondary); margin: 0.3rem 0 0;">Auto-detect models</p>
            </div>
          </div>
          <!-- Second Row: Driver Model Name -->
          <div class="driver-details-container" style="margin-top: 1rem;">
            <div class="driver-details-column">
              <h3>Driver Model Name (Manual)</h3>
              <input type="text" id="driverModelNameText" placeholder="Brother HL-L2350DW series" oninput="updateAllPreviews()">
            </div>
            <div class="driver-details-column">
              <h3>Select Model from INF</h3>
              <select id="driverModelNameSelect" onchange="updateAllPreviews()">
                <option value="">--Select Model--</option>
              </select>
            </div>
          </div>
          <div style="margin-top:1rem;">
            <button class="nav" type="button" onclick="previousSection('section2', 'section1')">Previous</button>
            <button class="nav" type="button" onclick="nextSection('section2', 'section3')">Next</button>
          </div>
        </div>
        
        <!-- Section 3: Driver & Config Settings -->
        <div class="section" id="section3" style="display: none;">
          <h2>Driver & Config Settings</h2>
          
          <!-- Hidden Input Fields (still needed for functionality) -->
          <input type="text" id="driverZipFile" list="driverZipOptions" placeholder="Select driver ZIP" oninput="updateAllPreviews()" style="display: none;">
          <datalist id="driverZipOptions"></datalist>
          <input type="text" id="configFilePath" placeholder="config.dat" oninput="updateAllPreviews()" style="display: none;">
          
          <!-- Three Column Layout -->
          <div class="section3-layout">
            <!-- Column 1: Config Export Command -->
            <div class="section3-column config-export-column">
              <h2>Config Export Command</h2>
              <label for="configExportFileName" style="margin-bottom: 0.5rem; font-size: 14px; font-weight: 500;">Config File Name:</label>
              <input type="text" id="configExportFileName" placeholder="config.dat" value="" oninput="updateAllPreviews()">
              <div class="preview-container">
                <div id="configExportPreview" class="preview-text"></div>
                <button class="copy-btn" onclick="copyConfigExportCommand(this)">
                  <svg width="16" height="16" viewBox="0 0 24 24">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14a2 2 0 0 0 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                  </svg>
                </button>
              </div>
            </div>
            
            <!-- Column 2: Install & Uninstall Commands -->
            <div class="section3-column commands-column">
              <h2>PowerShell Commands</h2>
              
              <div class="command-section">
                <h3 style="margin: 0 0 0.75rem 0; font-size: 16px; font-weight: 500; color: var(--text-primary);">Install Command</h3>
                <div class="preview-container">
                  <div id="installCommandPreview" class="preview-text"></div>
                  <button class="copy-btn" onclick="copyText('installCommandPreview', this)">
                    <svg width="16" height="16" viewBox="0 0 24 24">
                      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14a2 2 0 0 0 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="command-section">
                <h3 style="margin: 0 0 0.75rem 0; font-size: 16px; font-weight: 500; color: var(--text-primary);">Uninstall Command</h3>
                <div class="preview-container">
                  <div id="uninstallCommandPreview" class="preview-text"></div>
                  <button class="copy-btn" onclick="copyText('uninstallCommandPreview', this)">
                    <svg width="16" height="16" viewBox="0 0 24 24">
                      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14a2 2 0 0 0 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Column 3: Detection Information -->
            <div class="section3-column detection-column">
              <h2>Detection Registry Instructions</h2>
              <div id="detectionPreview"></div>
            </div>
          </div>
          
          <!-- Navigation Group at Bottom -->
          <div class="nav-group bottom-nav">
            <button class="nav" type="button" onclick="previousSection('section3', 'section2')">Previous</button>
            <button class="nav" type="button" onclick="downloadPackage()">Download Package</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- About Tab -->
    <div id="About" class="tabcontent">
      <h2>About Printune</h2>
      <p style="text-align: center">Printune was born out of countless frustrating experiences discovering inconsistent printer deployments via Intune.</p>
      <p style="text-align: center">Tired of imprecise configurations and the challenges of manual setups, I created a toolkit that makes deploying printers faster and more consistent for all levels of skill.</p>
      <p style="text-align: center">This streamlined interface and smart automation simplifies every step – from specifying printer details to organising deployment scripts.</p>
      <p style="text-align: center"><a href="https://github.com/NickJongens/Printune" target="_blank">GitHub repository</a></p>
    </div>
  </div>
  
  <!-- Footer -->
  <footer>
    &copy; Nick Jongens - 2025
  </footer>
  
  <!-- Include JSZip Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <script>
    // Global icon variables for copy/tick buttons
    const copyIconHTML = `<svg width="16" height="16" viewBox="0 0 24 24">
      <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14a2 2 0 0 0 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
    </svg>`;
    const tickIconHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>`;
    
    // Function to get current highlight color from CSS variables
    function getHighlightColor() {
      return getComputedStyle(document.documentElement).getPropertyValue('--highlight-color').trim();
    }
    
    function animateCopyButton(btn, originalIconHTML) {
      btn.innerHTML = tickIconHTML;
      setTimeout(() => {
        btn.innerHTML = originalIconHTML;
      }, 1000);
    }
    
    /* ---------------------------
       Dynamic Driver List
       --------------------------- */
    function populateDriverDatalist() {
      fetch('/drivers.json')
        .then(response => response.json())
        .then(data => {
          const datalist = document.getElementById("driverZipOptions");
          datalist.innerHTML = "";
          data.forEach(driver => {
            const option = document.createElement("option");
            option.value = driver;
            datalist.appendChild(option);
          });
        })
        .catch(error => {
          console.error("Error fetching driver list:", error);
        });
    }
    
    /* ---------------------------
       Models Dropdown Population
       --------------------------- */
    let modelsData = {};

    function populateBrandDropdown() {
      fetch('/models.json')
        .then(response => response.json())
        .then(data => {
          modelsData = data;
          const brandSelect = document.getElementById("brandSelect");
          brandSelect.innerHTML = '<option value="">--Select Brand--</option>';
          for (let brand in data) {
            const option = document.createElement("option");
            option.value = brand;
            option.textContent = brand;
            brandSelect.appendChild(option);
          }
        })
        .catch(error => {
          console.error("Error fetching models.json:", error);
        });
    }

    function onBrandChange() {
      const brand = document.getElementById("brandSelect").value;
      const modelSelect = document.getElementById("modelSelect");
      modelSelect.innerHTML = '<option value="">--Select Model--</option>';
      
      if (brand === "Manual" || !brand) {
        const manualOption = document.createElement("option");
        manualOption.value = "Manual";
        manualOption.textContent = "Manual";
        modelSelect.appendChild(manualOption);
        return;
      }
      if (modelsData[brand] && modelsData[brand].models) {
        modelsData[brand].models.forEach(model => {
          const option = document.createElement("option");
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
      }
    }

    function onModelChange() {
      const brand = document.getElementById("brandSelect").value;
      const model = document.getElementById("modelSelect").value;
      if (!brand || brand === "Manual" || !model) return;
      const mapping = modelsData[brand];
      if(mapping) {
         document.getElementById("driverZipFile").value = mapping.driverZip || "";
         document.getElementById("driverModelFile").value = mapping.driverInf || "";
         document.getElementById("driverModelNameText").value = model;
         updateAllPreviews();
      }
    }
    
    /* ---------------------------
       Tab & Section Navigation
       --------------------------- */
    function openTab(evt, tabName) {
      const tabcontent = document.getElementsByClassName("tabcontent");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }
    function nextSection(currentId, nextId) {
      document.getElementById(currentId).style.display = "none";
      document.getElementById(nextId).style.display = "block";
    }
    function previousSection(currentId, prevId) {
      document.getElementById(currentId).style.display = "none";
      document.getElementById(prevId).style.display = "block";
    }
    
    /* ---------------------------
       INF File Handling
       --------------------------- */
    function parseInfModels(infContent) {
      const lines = infContent.split(/\r?\n/);
      const models = new Set();
      let currentSection = "";
      for (const line of lines) {
        if (line.trim().startsWith(';')) continue;
        const sectionMatch = line.match(/^\s*\[([^\]]+)\]/);
        if (sectionMatch) {
          currentSection = sectionMatch[1].trim().toUpperCase();
          continue;
        }
        if (currentSection.startsWith("PRINTERS") || currentSection === "DRIVERNAME") {
          const modelMatch = line.match(/^\s*"([^"]+)"\s*=/);
          if (modelMatch) models.add(modelMatch[1].trim());
        } else if (currentSection === "STRINGS") {
          const printerKeyMatch = line.match(/^\s*PRINTER\d+\s*=\s*"([^"]+)"\s*$/i);
          if (printerKeyMatch) models.add(printerKeyMatch[1].trim());
        } else if (currentSection.startsWith("BRDRV_WINUSB")) { 
          const usbModelMatch = line.match(/^\s*"([^"]+)"\s*=/);
          if (usbModelMatch) models.add(usbModelMatch[1].trim());
        } else if (currentSection.startsWith("FFIDPF")) {
          const ffidpfModelMatch = line.match(/^\s*"([^"]+)"\s*=/);
          if (ffidpfModelMatch) models.add(ffidpfModelMatch[1].trim());
        }
      }
      return Array.from(models);
    }
    document.getElementById("infFile").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      document.infUploadedFileName = file.name;
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const models = parseInfModels(content);
        const selectEl = document.getElementById("driverModelNameSelect");
        selectEl.innerHTML = '<option value="">--Select Model--</option>';
        if (models.length > 0) {
          models.forEach(model => {
            const option = document.createElement("option");
            option.value = model;
            option.textContent = model;
            selectEl.appendChild(option);
          });
        } else {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No models found in INF";
          selectEl.appendChild(option);
        }
        updateAllPreviews();
      };
      reader.readAsText(file);
    });
    
    /* ---------------------------
       Command Generation
       --------------------------- */
    function updateInstallPreview() {
      const ipAddress = (document.getElementById("ipAddress")?.value || "").trim();
      const portName = (document.getElementById("portName")?.value || "").trim();
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      let driverModelFile = document.infUploadedFileName ? document.infUploadedFileName : (document.getElementById("driverModelFile")?.value || "").trim();
      let driverModelName = (document.getElementById("driverModelNameSelect")?.value || "").trim() || (document.getElementById("driverModelNameText")?.value || "").trim();
      const driverZipFile = (document.getElementById("driverZipFile")?.value || "").trim();
      const configFilePath = (document.getElementById("configFilePath")?.value || "").trim();
      const configExportFileName = (document.getElementById("configExportFileName")?.value || "").trim();
      const highlightColor = getHighlightColor();
      
      let command = `powershell.exe -ExecutionPolicy Bypass -File Install.ps1 `;
      if (ipAddress) command += `-PrinterPortIPAddress "<strong style='color:${highlightColor};'>${ipAddress}</strong>" `;
      if (portName) command += `-PrinterPortName "<strong style='color:${highlightColor};'>${portName}</strong>" `;
      if (printerName) command += `-PrinterName "<strong style='color:${highlightColor};'>${printerName}</strong>" `;
      if (driverModelName) command += `-PrinterDriverModelName "<strong style='color:${highlightColor};'>${driverModelName}</strong>" `;
      if (driverZipFile) {
        // Remove Driver/ prefix from ZIP filename for the install command
        const zipFileName = driverZipFile.split('/').pop();
        command += `-PrinterDriverZipFileName "<strong style='color:${highlightColor};'>${zipFileName}</strong>" `;
      }
      if (driverModelFile) command += `-PrinterDriverModelFileName "<strong style='color:${highlightColor};'>${driverModelFile}</strong>" `;
      if (configFilePath) command += `-ConfigFilePath "<strong style='color:${highlightColor};'>${configFilePath}</strong>" `;
      if (configExportFileName) command += `-ConfigFilePath "<strong style='color:${highlightColor};'>${configExportFileName}</strong>" `;
      
      document.getElementById("installCommandPreview").innerHTML = command;
    }
    function updateUninstallPreview() {
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      const portName = (document.getElementById("portName")?.value || "").trim();
      const highlightColor = getHighlightColor();
      let command = 'powershell.exe -ExecutionPolicy Bypass -File Uninstall.ps1 ';
      if (printerName) command += `-PrinterName "<strong style='color:${highlightColor};'>${printerName}</strong>" `;
      if (portName) command += `-PrinterPortName "<strong style='color:${highlightColor};'>${portName}</strong>" `;
      document.getElementById("uninstallCommandPreview").innerHTML = command;
    }
    function getPlainInstallCommand() {
      const ipAddress = (document.getElementById("ipAddress")?.value || "").trim();
      const portName = (document.getElementById("portName")?.value || "").trim();
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      let driverModelFile = document.infUploadedFileName ? document.infUploadedFileName : (document.getElementById("driverModelFile")?.value || "").trim();
      let driverModelName = (document.getElementById("driverModelNameSelect")?.value || "").trim() || (document.getElementById("driverModelNameText")?.value || "").trim();
      const driverZipFile = (document.getElementById("driverZipFile")?.value || "").trim();
      const configFilePath = (document.getElementById("configFilePath")?.value || "").trim();
      const configExportFileName = (document.getElementById("configExportFileName")?.value || "").trim();
      
      let command = `powershell.exe -ExecutionPolicy Bypass -File Install.ps1 `;
      if (ipAddress) command += `-PrinterPortIPAddress "${ipAddress}" `;
      if (portName) command += `-PrinterPortName "${portName}" `;
      if (printerName) command += `-PrinterName "${printerName}" `;
      if (driverModelName) command += `-PrinterDriverModelName "${driverModelName}" `;
      if (driverZipFile) {
        // Remove Driver/ prefix from ZIP filename for the install command
        const zipFileName = driverZipFile.split('/').pop();
        command += `-PrinterDriverZipFileName "${zipFileName}" `;
      }
      if (driverModelFile) command += `-PrinterDriverModelFileName "${driverModelFile}" `;
      if (configFilePath) command += `-ConfigFilePath "${configFilePath}" `;
      if (configExportFileName) command += `-ConfigFilePath "${configExportFileName}" `;
      return command.trim();
    }
    function getPlainUninstallCommand() {
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      const portName = (document.getElementById("portName")?.value || "").trim();
      let command = 'powershell.exe -ExecutionPolicy Bypass -File Uninstall.ps1 ';
      if (printerName) command += `-PrinterName "${printerName}" `;
      if (portName) command += `-PrinterPortName "${portName}" `;
      return command.trim();
    }
    
    // Generate plain-text config export command for copying
    function getPlainConfigExportCommand() {
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      const configExportFileName = (document.getElementById("configExportFileName")?.value || "config.dat").trim();
      
      // Sanitize printer name by removing double quotes to avoid breaking the command
      const sanitizedPrinterName = printerName.replace(/"/g, '') || "<PrinterName>";
      
      return `rundll32 printui.dll,PrintUIEntry /Ss /n "${sanitizedPrinterName}" /a "${configExportFileName}"`;
    }
    
    // Update the HTML-highlighted config export command preview
    function updateConfigExportPreview() {
      const printerName = (document.getElementById("printerName")?.value || "").trim();
      const configExportFileName = (document.getElementById("configExportFileName")?.value || "config.dat").trim();
      const highlightColor = getHighlightColor();
      
      // Sanitize printer name by removing double quotes to avoid breaking the command
      const sanitizedPrinterName = printerName.replace(/"/g, '') || "<PrinterName>";
      
      let command = `rundll32 printui.dll,PrintUIEntry /Ss /n "<strong style='color:${highlightColor};'>${sanitizedPrinterName}</strong>" /a "<strong style='color:${highlightColor};'>${configExportFileName}</strong>"`;
      
      document.getElementById("configExportPreview").innerHTML = command;
    }
    function updateAllPreviews() {
      updateInstallPreview();
      updateUninstallPreview();
      updateConfigExportPreview();
      updateDetectionPreview();
    }
    function updateDetectionPreview() {
      const printerName = (document.getElementById("printerName")?.value || "<PrinterName>").trim();
      const container = document.getElementById("detectionPreview");
      container.innerHTML = "";
      
      const detectionFields = [
        { label: "Registry Key Path:", value: `HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Print\\Printers\\${printerName}`, copy: true, purple: true },
        { label: "Value name:", value: "Name", copy: true, purple: true },
        { label: "Detection method:", value: "String comparison", copy: true, purple: true },
        { label: "Operator:", value: "Equals", copy: false, purple: true },
        { label: "Value:", value: printerName, copy: true, purple: true }
      ];
      
      detectionFields.forEach(field => {
        const block = document.createElement("div");
        block.className = "detection-block";
        
        const labelDiv = document.createElement("div");
        labelDiv.className = "detection-label";
        labelDiv.innerText = field.label;
        block.appendChild(labelDiv);
        
        const valueDiv = document.createElement("div");
        valueDiv.className = "detection-value";
        if (field.purple) { valueDiv.classList.add("detection-purple"); }
        valueDiv.innerText = field.value;
        
        if (field.copy) {
          const btn = document.createElement("button");
          btn.className = "copy-btn";
          btn.innerHTML = copyIconHTML;
          btn.onclick = function() {
            navigator.clipboard.writeText(field.value)
              .then(() => { animateCopyButton(btn, copyIconHTML); })
              .catch(err => { console.error("Error copying text:", err); });
          };
          valueDiv.appendChild(btn);
        }
        block.appendChild(valueDiv);
        container.appendChild(block);
      });
    }
    
    // Copy function for command previews
    function copyText(elementId, btn) {
      const el = document.getElementById(elementId);
      const text = el.innerText || el.textContent;
      navigator.clipboard.writeText(text)
        .then(() => { animateCopyButton(btn, copyIconHTML); })
        .catch(err => { console.error("Error copying text:", err); });
    }
    
    // Copy function specifically for config export command (uses plain text version)
    function copyConfigExportCommand(btn) {
      const command = getPlainConfigExportCommand();
      navigator.clipboard.writeText(command)
        .then(() => { animateCopyButton(btn, copyIconHTML); })
        .catch(err => { console.error("Error copying config export command:", err); });
    }
    
    /* ---------------------------
       Package Download Functions
       --------------------------- */
    async function generateZipPackage() {
      const zip = new JSZip();
      const promises = [];

      // Add Install.ps1
      const installPromise = fetch("/Install.ps1")
        .then(response => response.text())
        .then(text => zip.file("Install.ps1", text));
      promises.push(installPromise);

      // Add Uninstall.ps1
      const uninstallPromise = fetch("/Uninstall.ps1")
        .then(response => response.text())
        .then(text => zip.file("Uninstall.ps1", text));
      promises.push(uninstallPromise);

      // Add driver ZIP if specified
      const driverZipFileName = (document.getElementById("driverZipFile")?.value || "").trim();
      if (driverZipFileName) {
        // Ensure the fetch URL includes the Driver/ prefix
        const fetchUrl = driverZipFileName.startsWith('Driver/') ? `/${driverZipFileName}` : `/Driver/${driverZipFileName}`;
        console.log(`Attempting to fetch driver ZIP from: ${fetchUrl}`);
        const driverPromise = fetch(fetchUrl)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Failed to fetch driver ZIP from ${fetchUrl}: ${response.status} ${response.statusText}`);
            }
            console.log(`Successfully fetched driver ZIP: ${driverZipFileName}`);
            return response.arrayBuffer();
          })
          .then(data => {
            // Extract just the filename without the Driver/ prefix for the ZIP file
            const zipFileName = driverZipFileName.split('/').pop();
            return zip.file(zipFileName, data);
          });
        promises.push(driverPromise);
      } else {
        console.log("No driver ZIP file specified");
      }

      await Promise.all(promises);
      return zip.generateAsync({ type: "blob" });
    }

    function sanitizeFileName(name) {
      return name.replace(/[<>:"/\\|?*]+/g, "_") || "PrinterDeployment";
    }

    function triggerDownload(blob, mimeType, fileName) {
      const url = window.URL.createObjectURL(new Blob([blob], { type: mimeType }));
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    }

    async function downloadPackage() {
      const btn = document.querySelector('#section3 button[onclick="downloadPackage()"]');
      const originalContent = btn.innerHTML;
      btn.classList.add('loading');
      btn.disabled = true;
      btn.innerHTML = 'Processing...';

      try {
        const zipContent = await generateZipPackage();
        const printerName = sanitizeFileName(document.getElementById("printerName").value.trim());
        triggerDownload(zipContent, "application/zip", `${printerName}.zip`);
        
        // Show success feedback
        btn.innerHTML = '✓ Downloaded!';
        btn.style.background = 'linear-gradient(180deg, #10b981, #059669)';
        setTimeout(() => {
          btn.innerHTML = originalContent;
          btn.style.background = '';
          btn.classList.remove('loading');
          btn.disabled = false;
        }, 2000);
      } catch (error) {
        console.error("Package generation error:", error);
        btn.innerHTML = '✗ Error';
        btn.style.background = 'linear-gradient(180deg, #ef4444, #dc2626)';
        setTimeout(() => {
          btn.innerHTML = originalContent;
          btn.style.background = '';
          btn.classList.remove('loading');
          btn.disabled = false;
        }, 2000);
        alert(`Error generating package: ${error.message}`);
      }
    }

    async function downloadIntuneWin() {
      const btn = document.querySelector('.intune-download-btn');
      const originalContent = btn.innerHTML;
      btn.innerHTML = '<div class="spinner azure-spinner"></div> Processing...';
      btn.disabled = true;

      try {
        const zipContent = await generateZipPackage();
        const printerName = sanitizeFileName(document.getElementById("printerName").value.trim());
        
        const formData = new FormData();
        formData.append("zipFile", zipContent, `${printerName}.zip`);
        formData.append("setupFileName", "Install.ps1");

        const response = await fetch("https://packtune.jongens.nz/api/Package", {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }

        const intuneBlob = await response.blob();
        triggerDownload(intuneBlob, "application/intunewin", `${printerName}.intunewin`);
      } catch (error) {
        console.error("Intune packaging error:", error);
        alert(`IntuneWin creation failed: ${error.message}`);
      } finally {
        btn.innerHTML = originalContent;
        btn.disabled = false;
      }
    }
    
    // Theme toggle functionality
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // Update the theme toggle icon
      const themeToggle = document.querySelector('.theme-toggle svg');
      if (newTheme === 'light') {
        themeToggle.innerHTML = '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>';
      } else {
        themeToggle.innerHTML = '<path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>';
      }
      
      // Refresh all previews to update highlighting colors
      setTimeout(() => {
        updateAllPreviews();
      }, 100);
    }

    // Initialize theme from localStorage
    function initializeTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      // Set initial icon
      const themeToggle = document.querySelector('.theme-toggle svg');
      if (savedTheme === 'light') {
        themeToggle.innerHTML = '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>';
      }
    }

    // Keyboard shortcuts and accessibility improvements
    document.addEventListener("keydown", function(event) {
      // Ctrl/Cmd + Enter to download package
      if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        const downloadBtn = document.querySelector('button[onclick="downloadPackage()"]');
        if (downloadBtn && !downloadBtn.disabled) {
          downloadPackage();
        }
      }
      
      // Escape to go back
      if (event.key === 'Escape') {
        const currentSection = document.querySelector('.section[style*="block"]');
        if (currentSection && currentSection.id === 'section3') {
          previousSection('section3', 'section2');
        }
      }
      
      // Tab navigation improvements
      if (event.key === 'Tab') {
        document.body.classList.add('keyboard-navigation');
      }
    });
    
    // Remove keyboard navigation class on mouse use
    document.addEventListener('mousedown', function() {
      document.body.classList.remove('keyboard-navigation');
    });
    
    // Add focus indicators for keyboard navigation
    const style = document.createElement('style');
    style.textContent = `
      .keyboard-navigation *:focus {
        outline: 2px solid var(--accent-color) !important;
        outline-offset: 2px !important;
      }
    `;
    document.head.appendChild(style);

    // Initialize the dynamic lists on DOMContentLoaded
    document.addEventListener("DOMContentLoaded", function() {
      populateDriverDatalist();
      populateBrandDropdown();
      initializeTheme();
      
      // Add ARIA labels for better accessibility
      document.querySelectorAll('button').forEach(btn => {
        if (!btn.getAttribute('aria-label') && btn.textContent) {
          btn.setAttribute('aria-label', btn.textContent.trim());
        }
      });
      
      // Add role attributes
      document.querySelectorAll('.preview-container').forEach(container => {
        container.setAttribute('role', 'textbox');
        container.setAttribute('aria-readonly', 'true');
      });
    });
  </script>
</body>
</html>
